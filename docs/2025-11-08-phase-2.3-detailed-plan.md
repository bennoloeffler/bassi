# Phase 2.3: Dependency Inversion for Testing - Detailed Plan

**Status**: PENDING (Planning Complete)
**Created**: 2025-11-08
**Context**: Section 2.3 of refactoring plan

---

## Executive Summary

### Current Problem
Running `pytest` fails during collection because `claude_agent_sdk` is not installed in CI/dev containers. Any import that touches `bassi.agent` or `bassi/core_v3/agent_session.py` crashes immediately with:

```
ModuleNotFoundError: No module named 'claude_agent_sdk'
```

This blocks 14+ suites (all agent/web-session tests) and prevents us from exercising agent code paths locally or in CI. The issue is structural: production code imports the SDK at module import time, so tests have no way to stub the dependency.

### Root Cause
- Tight coupling between `BassiAgentSession`/`BassiAgent` and the Claude Agent SDK (`ClaudeSDKClient`).
- No adapter or injection point for providing a fake SDK client in tests.
- Tests that should be unit/integration level are forced to touch the real SDK (which we cannot ship in OSS/CI environments).

### Goals for Phase 2.3
1. Invert the dependency on the Claude Agent SDK so that production builds still use it, but tests can supply mocks without importing the package.
2. Provide first-class mock fixtures so unit tests can validate streaming, verbose toggling, context persistence, etc., without network calls.
3. Clean up async fixtures and HTTP clients only where necessary to support the new abstraction (full event-loop rework can happen later if still needed).

---

## Critique of Previous Draft
- ‚ùå Focused on FastAPI `TestClient` event loop conflicts that are not the immediate blocker (those failures only appear once the SDK import succeeds).
- ‚ùå Deferred the actual dependency inversion that Section 2.3 scoped.
- ‚úÖ Highlighted test reliability concerns, but mixed them into the critical path, which dilutes effort.

**Updated viewpoint**: unblock tests first by decoupling the SDK; then, once agent tests run in CI, we can revisit broader async/test-structure improvements.

---

## Implementation Strategy

### Phase 2.3A: Introduce AgentClient Abstraction (Critical Path) üî•

1. **Define protocol & factory**  
   - File: `bassi/shared/agent_protocol.py`  
   - Add `AgentClient` `Protocol` capturing the async surface we rely on: `connect`, `disconnect`, `query`, `receive_response`, `interrupt`, `get_server_info`.  
   - Define `AgentClientFactory = Callable[[SessionConfig], AgentClient]` so entry points can lazily construct the real client.

2. **Add Claude adapter**  
   - File: `bassi/shared/agent_protocol.py` or `bassi/shared/agent_client.py` (decide based on size).  
   - Move the direct `ClaudeSDKClient` import inside the adapter so importing `bassi.core_v3.agent_session` no longer requires the SDK.  
   - Adapter is responsible for translating `SessionConfig` ‚Üí `ClaudeAgentOptions`.

3. **Update `BassiAgentSession`**  
   - File: `bassi/core_v3/agent_session.py`.  
   - Accept optional `client_factory` (defaults to real Claude factory).  
   - Lazily instantiate the client in `connect()` by calling the factory; allow tests to pass prebuilt mock clients.  
   - Ensure reconnect/ thinking-mode toggles rebuild clients via the factory instead of referencing the SDK directly.  
   - Remove module-level SDK imports; rely solely on the adapter.

4. **Update legacy V1 agent**  
   - File: `bassi/agent.py`.  
   - Mirror the same factory-based creation so both code paths share the abstraction and stay testable.

5. **Wire entry points**  
   - Files: `bassi/main.py`, `bassi/core_v3/web_server_v3.py`, CLI/WS server bootstraps.  
   - Pass the factory into any place that instantiates `BassiAgentSession` or `BassiAgent`.  
   - Verify runtime config (permission mode, hooks, mcp servers) still flows through unchanged.

**Success Criteria**: Importing any agent module no longer imports `claude_agent_sdk`; `pytest` collects all suites without ModuleNotFound errors.

---

### Phase 2.3B: Testing Infrastructure & Fixtures

1. **Mock client implementation**  
   - File: `tests/fixtures/mock_agent_client.py` (shared for V1/V3).  
   - Implements `AgentClient` protocol with deterministic async iterators so tests can simulate streaming responses, tool calls, interrupts, and stats updates.  
   - Provide helper methods to enqueue scripted events per test.

2. **Fixture wiring**  
   - File: `tests/conftest.py` and/or `bassi/core_v3/tests/conftest.py`.  
   - Add fixtures like `mock_agent_client`, `session_factory_with_mock`, etc., so tests can override the default factory via dependency injection hooks already present in CLI/web server constructors.  
   - Document fixture usage in the module docstring.

3. **Test migrations**  
   - Unskip and refactor `tests/test_agent.py`, `tests/test_verbose.py`, `tests/test_use_cases.py`, and `bassi/core_v3/tests/test_agent_session.py` to rely on the mock factory.  
   - Add new tests specifically targeting streaming/state behavior now that it‚Äôs injectable.  
   - Ensure no test imports `claude_agent_sdk`.

4. **CI verification**  
   - Run targeted suites (`pytest tests/test_agent.py`, `pytest bassi/core_v3/tests/test_agent_session.py`) to confirm they pass without the SDK.  
   - Then run full `pytest` to ensure zero `ModuleNotFoundError` occurrences.

**Success Criteria**: Agent-related tests pass locally/CI without the proprietary SDK; we gain coverage for previously skipped scenarios.

---

### Phase 2.3C: Optional Async/Test Cleanup (Post-Abstraction)

Only tackle if time permits or if residual failures appear after Phase A/B.

Potential follow-ups:
- Replace `fastapi.testclient.TestClient` usages with `httpx.AsyncClient` to avoid nested event loops.  
- Consolidate async fixtures in `conftest.py` to remove duplication.  
- Reorganize tests into `unit/`, `integration/`, `e2e/` folders and adjust `pyproject.toml` `testpaths`.  
- Review Playwright E2E setup to ensure it spins up the actual server when needed.

These improvements remain valuable but are no longer blocking Section 2.3 once dependency inversion is complete.

---

## Task Breakdown

| Phase | Task | Owner | Status |
| --- | --- | --- | --- |
| 2.3A | Create `AgentClient` protocol + factory types | Codex | ‚òê |
| 2.3A | Implement Claude adapter + move SDK imports | Codex | ‚òê |
| 2.3A | Refactor `BassiAgentSession` to use factories | Codex | ‚òê |
| 2.3A | Update V1 agent + entry points | Codex | ‚òê |
| 2.3B | Build mock client + fixtures | Codex | ‚òê |
| 2.3B | Migrate agent/session tests to mocks | Codex | ‚òê |
| 2.3B | Run pytest suites and document results | Codex | ‚òê |
| 2.3C | (Optional) Async fixture cleanup | Future | ‚òê |

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
| --- | --- | --- |
| Protocol drift when SDK surface changes | Medium | Keep adapter isolated; document how to extend protocol |
| Reconnect logic regresses after factory refactor | Medium | Add regression tests covering thinking-mode toggles and reconnect paths using mocks |
| Tests still import SDK indirectly | Medium | CI gate: `rg -l "claude_agent_sdk" tests/` must stay empty |
| Optional async cleanup postponed too long | Low | Track via follow-up ticket once dependency inversion lands |

---

## Success Metrics

- ‚úÖ `pytest` collection succeeds without `claude_agent_sdk` installed.  
- ‚úÖ All agent/session/unit tests pass using mocks.  
- ‚úÖ No production behavior change (manual smoke test via CLI/WS).  
- ‚úÖ Documentation updated to explain the new abstraction boundary.

---

## Next Steps

1. Implement Phase 2.3A (protocol + factory + adapter + session refactor).  
2. Build mock client + fixtures and migrate tests (Phase 2.3B).  
3. Re-run full test matrix; if failures remain tied to async/TestClient issues, schedule Phase 2.3C.  
4. Update architecture docs to describe the new dependency inversion layer.

### Latest Updates (2025‚Äë11‚Äë08)

- `BassiAgent` now consumes the shared `AgentClient` protocol and can be unit-tested with the same mock factory as V3 sessions.  
- CLI key handling re-enables `ISIG`, so a single Ctrl+C cleanly terminates the prompt loop and satisfies the PTY key-binding tests.

---

## Appendix: Rejected Alternatives

1. **Vendoring `claude_agent_sdk` into the repo** ‚Äì violates licensing, still couples tests to real API.  
2. **Conditional imports with try/except** ‚Äì merely hides the error until runtime; tests would still skip agent logic entirely.  
3. **Monkeypatching SDK classes in tests** ‚Äì brittle, requires SDK to be importable in the first place.  
4. **Stubbing at the network layer** ‚Äì complex and still forces us to install the SDK; better to abstract at the client boundary.
