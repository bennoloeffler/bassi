# Phase 2.3: Dependency Inversion - Code Implementation Guide

**Status**: Ready for Implementation
**Created**: 2025-11-08
**Purpose**: Concrete code changes to complete Phase 2.3 dependency injection

---

## Overview

This document contains **exact code changes** needed to complete Phase 2.3. All V3 infrastructure exists; only V1 needs updates.

**Implementation Time**: ~90 minutes
**Files Changed**: 3 files (agent.py, test_agent.py, main.py)
**Files Verified**: 2 files (web_server_v3.py, cli.py)

---

## Change #1: Add Dependency Injection to V1 Agent

**File**: `bassi/agent.py`

### 1.1 Update Imports (Lines 1-35)

**BEFORE**:
```python
# Line 30
from bassi.shared.sdk_loader import ClaudeAgentOptions, ClaudeSDKClient
```

**AFTER**:
```python
# Line 30 - Remove direct SDK import
from bassi.shared.agent_protocol import (
    AgentClient,
    AgentClientFactory,
    default_claude_client_factory,
)
```

**Reason**: Decouple from SDK at module level, use protocol instead.

---

### 1.2 Update Type Hints (Line 274)

**BEFORE**:
```python
# Line 274
self.client: ClaudeSDKClient | None = None
```

**AFTER**:
```python
# Line 274
self.client: AgentClient | None = None
```

**Reason**: Use protocol type for flexibility.

---

### 1.3 Add Factory Parameter to __init__ (Lines 216-301)

**BEFORE**:
```python
def __init__(
    self,
    permission_mode: str = "bypassPermissions",
    verbose: bool = False,
    mcp_servers: list[str] | None = None,
    thinking_mode: bool = False,
    status_callback: Callable[[str], None] | None = None,
):
    """Initialize bassi agent.

    Args:
        permission_mode: Permission mode for tool execution
        verbose: Enable verbose output (show thinking)
        mcp_servers: List of MCP servers to enable
        thinking_mode: Enable extended thinking mode
        status_callback: Optional callback for status updates
    """
    self.permission_mode = permission_mode
    self.verbose = verbose
    self.thinking_mode = thinking_mode
    self.status_callback = status_callback or (lambda msg: None)

    # ... rest of initialization
```

**AFTER**:
```python
def __init__(
    self,
    permission_mode: str = "bypassPermissions",
    verbose: bool = False,
    mcp_servers: list[str] | None = None,
    thinking_mode: bool = False,
    status_callback: Callable[[str], None] | None = None,
    client_factory: AgentClientFactory | None = None,  # NEW
):
    """Initialize bassi agent.

    Args:
        permission_mode: Permission mode for tool execution
        verbose: Enable verbose output (show thinking)
        mcp_servers: List of MCP servers to enable
        thinking_mode: Enable extended thinking mode
        status_callback: Optional callback for status updates
        client_factory: Factory function to create AgentClient instances.
                       Defaults to default_claude_client_factory for
                       production use. Override with mock factory for testing.
    """
    self.permission_mode = permission_mode
    self.verbose = verbose
    self.thinking_mode = thinking_mode
    self.status_callback = status_callback or (lambda msg: None)

    # Store factory (defaults to production Claude SDK factory)
    self._client_factory = client_factory or default_claude_client_factory

    # ... rest of initialization
```

**Reason**: Enable dependency injection for testing.

---

### 1.4 Update Client Creation in chat() Method (Lines 440-450)

**BEFORE**:
```python
# Around line 446-447
if self.client is None:
    self.client = ClaudeSDKClient(options=self.options)
```

**AFTER**:
```python
# Around line 446-447
if self.client is None:
    # Create SessionConfig from current options
    from bassi.core_v3.agent_session import SessionConfig

    config = SessionConfig(
        permission_mode=self.permission_mode,
        model_id=self.model,
        thinking_mode=self.thinking_mode,
        # Map V1 options to V3 config as needed
    )

    # Use factory to create client (allows test injection)
    self.client = self._client_factory(config)

    # Ensure client is connected
    if not hasattr(self.client, '_connected') or not self.client._connected:
        # Client needs async connect, but V1 is sync wrapper
        # This is handled by the factory's client implementation
        pass
```

**Alternative Simpler Approach** (if SessionConfig conversion is complex):
```python
# Around line 446-447
if self.client is None:
    # For V1, we can pass a minimal config or use the factory directly
    # The factory already knows how to build from SessionConfig
    from bassi.core_v3.agent_session import SessionConfig

    config = SessionConfig(
        permission_mode=self.permission_mode,
    )

    # Let factory create the client
    self.client = self._client_factory(config)
```

**Reason**: Use factory pattern instead of direct instantiation.

---

### 1.5 Store Factory Reference (Add to __init__)

Add this to the `__init__` method after line ~220:

```python
def __init__(
    self,
    permission_mode: str = "bypassPermissions",
    verbose: bool = False,
    mcp_servers: list[str] | None = None,
    thinking_mode: bool = False,
    status_callback: Callable[[str], None] | None = None,
    client_factory: AgentClientFactory | None = None,
):
    """..."""
    # Existing code...
    self.permission_mode = permission_mode
    self.verbose = verbose
    self.thinking_mode = thinking_mode
    self.status_callback = status_callback or (lambda msg: None)

    # NEW: Store factory for lazy client creation
    self._client_factory = client_factory or default_claude_client_factory

    # Rest of existing initialization...
    self.client: AgentClient | None = None
    # ... etc
```

---

## Change #2: Write V1 Unit Tests with Mocks

**File**: `tests/test_agent.py`

### 2.1 Add Imports at Top

Add after existing imports:

```python
from bassi.shared.agent_protocol import AgentClientFactory
from tests.fixtures.mock_agent_client import MockAgentClient
```

---

### 2.2 Add Mock Factory Fixture

Add this fixture after the existing fixtures (~line 50):

```python
@pytest.fixture
def mock_client_factory(mock_agent_client):
    """
    Factory that returns a mock agent client for testing.

    This allows BassiAgent to be tested without the real Claude SDK.
    """
    def factory(config) -> AgentClient:
        # Return the same mock instance for all calls
        # (tests can reset/configure it as needed)
        return mock_agent_client

    return factory
```

---

### 2.3 Test: Agent Chat with Mock

Add this test after `test_agent_has_mcp_servers`:

```python
@pytest.mark.asyncio
async def test_agent_chat_with_mock(mock_api_key, mock_client_factory, mock_agent_client):
    """
    Test that BassiAgent.chat() uses the injected mock client.

    Verifies:
    - Agent uses factory-provided client
    - Messages are sent to client
    - Responses are streamed back
    - No real API calls are made
    """
    # Queue a mock response
    mock_agent_client.queue_response(
        "Hello! I'm a mock response from the test."
    )

    # Create agent with mock factory
    agent = BassiAgent(
        permission_mode="bypassPermissions",
        client_factory=mock_client_factory,
    )

    # Send a chat message
    responses = []
    async for chunk in agent.chat("What is 2+2?"):
        responses.append(chunk)

    # Verify mock was used
    assert len(mock_agent_client.sent_prompts) == 1
    assert "2+2" in mock_agent_client.sent_prompts[0]

    # Verify response was received
    assert len(responses) > 0
    full_response = "".join(responses)
    assert "mock response" in full_response.lower()

    # Verify no real SDK was used
    assert mock_agent_client.connect_called
    assert not hasattr(agent.client, 'api_key')  # Mock has no api_key


@pytest.mark.asyncio
async def test_agent_interrupt_with_mock(mock_api_key, mock_client_factory, mock_agent_client):
    """
    Test that BassiAgent.interrupt() delegates to the mock client.

    Verifies:
    - Interrupt is called on client
    - Mock tracks the interrupt state
    """
    # Create agent with mock factory
    agent = BassiAgent(
        permission_mode="bypassPermissions",
        client_factory=mock_client_factory,
    )

    # Start a chat to create the client
    mock_agent_client.queue_response("Working on it...")
    async for _ in agent.chat("Do something"):
        break  # Just establish client

    # Call interrupt
    agent.interrupt()

    # Verify mock client received interrupt
    assert mock_agent_client.interrupted


@pytest.mark.asyncio
async def test_agent_verbose_mode_with_mock(mock_api_key, mock_client_factory, mock_agent_client):
    """
    Test that verbose mode can be toggled with mock client.

    Verifies:
    - set_verbose() method works
    - verbose toggle method works
    - No API calls required for mode changes
    """
    # Create agent with mock factory
    agent = BassiAgent(
        permission_mode="bypassPermissions",
        verbose=False,
        client_factory=mock_client_factory,
    )

    # Test toggle
    agent.toggle_verbose()
    assert agent.verbose is True

    agent.toggle_verbose()
    assert agent.verbose is False

    # Test set_verbose
    agent.set_verbose(True)
    assert agent.verbose is True

    agent.set_verbose(False)
    assert agent.verbose is False


def test_agent_accepts_custom_factory(mock_api_key):
    """
    Test that BassiAgent accepts and stores custom client factory.

    Verifies:
    - Factory parameter is accepted
    - Factory is stored for later use
    - Default factory is used when none provided
    """
    # Custom factory that tracks calls
    factory_called = []

    def custom_factory(config):
        factory_called.append(config)
        return MockAgentClient()

    # Create agent with custom factory
    agent = BassiAgent(
        permission_mode="bypassPermissions",
        client_factory=custom_factory,
    )

    # Verify factory was stored
    assert agent._client_factory == custom_factory

    # Create agent without factory (should use default)
    agent_default = BassiAgent(
        permission_mode="bypassPermissions",
    )

    # Verify default factory is used
    from bassi.shared.agent_protocol import default_claude_client_factory
    assert agent_default._client_factory == default_claude_client_factory


@pytest.mark.asyncio
async def test_agent_reset_clears_mock_client(mock_api_key, mock_client_factory, mock_agent_client):
    """
    Test that reset() clears the client instance.

    Verifies:
    - Client is set to None after reset
    - Mock tracking is preserved (for test inspection)
    """
    # Create agent with mock factory
    agent = BassiAgent(
        permission_mode="bypassPermissions",
        client_factory=mock_client_factory,
    )

    # Establish client
    mock_agent_client.queue_response("Initial response")
    async for _ in agent.chat("Hello"):
        break

    assert agent.client is not None
    assert mock_agent_client.connect_called

    # Reset agent
    agent.reset()

    # Verify client is cleared
    assert agent.client is None

    # Mock client still tracks history (for test verification)
    assert len(mock_agent_client.sent_prompts) == 1
```

---

### 2.4 Update Existing Integration Test

Update the `test_agent_chat_integration` test to clarify it requires real SDK:

```python
@pytest.mark.integration
@pytest.mark.skipif(
    not SDK_AVAILABLE,
    reason="Requires claude-agent-sdk for integration testing"
)
def test_agent_chat_integration(mock_api_key):
    """
    Integration test with real Claude SDK.

    REQUIRES: claude-agent-sdk installed
    SKIPPED: In CI without SDK

    Note: Unit tests above use mocks and run without SDK.
    """
    # Existing test code...
```

---

## Change #3: Update V1 Entry Point to Support Factory

**File**: `bassi/main.py`

### 3.1 Add Import at Top

Add after existing imports (~line 20):

```python
from bassi.shared.agent_protocol import AgentClientFactory
```

---

### 3.2 Update main() Function Signature

**BEFORE** (around line 650):
```python
def main():
    """Main entry point for bassi CLI."""
    # Parse arguments...
```

**AFTER**:
```python
def main(client_factory: AgentClientFactory | None = None):
    """
    Main entry point for bassi CLI.

    Args:
        client_factory: Optional factory for creating agent clients.
                       Used for testing. Production uses default Claude SDK.
    """
    # Parse arguments...
```

---

### 3.3 Pass Factory to BassiAgent Constructor

Find all places where `BassiAgent()` is instantiated and add factory parameter.

**Location 1** (~line 364 - First time agent creation):

**BEFORE**:
```python
agent = BassiAgent(
    permission_mode=config.permission_mode,
    verbose=args.verbose,
    mcp_servers=mcp_servers,
    thinking_mode=args.thinking_mode,
    status_callback=status_callback,
)
```

**AFTER**:
```python
agent = BassiAgent(
    permission_mode=config.permission_mode,
    verbose=args.verbose,
    mcp_servers=mcp_servers,
    thinking_mode=args.thinking_mode,
    status_callback=status_callback,
    client_factory=client_factory,  # NEW
)
```

**Location 2** (~line 583 - Session resumption):

**BEFORE**:
```python
agent = BassiAgent(
    permission_mode=config.permission_mode,
    verbose=loaded_context.get("verbose", False),
    mcp_servers=mcp_servers,
    thinking_mode=loaded_context.get("thinking_mode", False),
    status_callback=status_callback,
)
```

**AFTER**:
```python
agent = BassiAgent(
    permission_mode=config.permission_mode,
    verbose=loaded_context.get("verbose", False),
    mcp_servers=mcp_servers,
    thinking_mode=loaded_context.get("thinking_mode", False),
    status_callback=status_callback,
    client_factory=client_factory,  # NEW
)
```

**Location 3** (~line 594 - After context load):

Apply same pattern as above.

**Location 4** (~line 606 - Fresh start):

Apply same pattern as above.

---

### 3.4 Add Helper for Testing

Add this at the end of the file (after `if __name__ == "__main__"`):

```python
def main_with_mock(mock_factory: AgentClientFactory):
    """
    Entry point for testing with mock agent client.

    Args:
        mock_factory: Factory that creates mock AgentClient instances

    Example:
        >>> from tests.fixtures.mock_agent_client import MockAgentClient
        >>> def mock_factory(config):
        ...     return MockAgentClient()
        >>> main_with_mock(mock_factory)
    """
    return main(client_factory=mock_factory)
```

**Reason**: Makes it easy for tests to invoke main() with mocks.

---

## Change #4: Verify V3 Web Server Factory Usage

**File**: `bassi/core_v3/web_server_v3.py`

### 4.1 Check session_factory Parameter

**Find** (search for `session_factory`):
- Line where `WebUIServerV3.__init__()` is defined
- Line where `BassiAgentSession` is created

**Expected Pattern**:
```python
class WebUIServerV3:
    def __init__(
        self,
        session_factory: Callable[[InteractiveQuestionService], BassiAgentSession],
        host: str = "localhost",
        port: int = 8766,
    ):
        self._session_factory = session_factory
        # ...

    async def create_session(self, question_service):
        # Should call factory to create session
        session = self._session_factory(question_service)
        return session
```

**If Missing**: Add factory parameter support similar to V1 main().

---

### 4.2 Verify WebSocket Session Creation

**Search for**: Where new sessions are created when WebSocket connects

**Expected**:
```python
# Should use factory pattern
session = self._session_factory(question_service)
# NOT: session = BassiAgentSession(config)  # Direct instantiation
```

**Action**:
- ✅ If using factory → No changes needed
- ❌ If direct instantiation → Refactor to use factory

---

## Change #5: Verify V3 CLI Factory Usage

**File**: `bassi/core_v3/cli.py`

### 5.1 Check main() Function

**Find** (around line 20-50):
- Where `WebUIServerV3` is instantiated
- Where `session_factory` is defined

**Expected Pattern**:
```python
def main(client_factory: AgentClientFactory | None = None):
    """V3 web UI entry point."""

    # Define session factory
    def session_factory(question_service: InteractiveQuestionService):
        config = SessionConfig(
            permission_mode="bypassPermissions",
        )
        return BassiAgentSession(
            config=config,
            client_factory=client_factory,  # Pass through
        )

    # Create server with factory
    server = WebUIServerV3(
        session_factory=session_factory,
        host="localhost",
        port=8766,
    )

    # Run server
    asyncio.run(server.serve())
```

**If Missing**: Add `client_factory` parameter to `main()` and pass it through.

---

## Verification Checklist

After implementing all changes above:

### Unit Tests (No SDK Required)

```bash
# Should pass without claude-agent-sdk installed
uv run pytest tests/test_agent.py -v -k "test_agent_chat_with_mock"
uv run pytest tests/test_agent.py -v -k "test_agent_interrupt_with_mock"
uv run pytest tests/test_agent.py -v -k "test_agent_verbose_mode_with_mock"
uv run pytest tests/test_agent.py -v -k "test_agent_accepts_custom_factory"
uv run pytest tests/test_agent.py -v -k "test_agent_reset_clears_mock_client"
```

### Integration Tests (SDK Required)

```bash
# Should skip gracefully without SDK
uv run pytest tests/test_agent.py::test_agent_chat_integration -v

# Should pass with SDK installed
ANTHROPIC_API_KEY=sk-... uv run pytest tests/test_agent.py::test_agent_chat_integration -v
```

### Full Test Suite

```bash
# All tests should collect without import errors
uv run pytest --collect-only

# All unit tests should pass
uv run pytest -v -m "not integration"

# Integration tests should skip without SDK
uv run pytest -v -m integration
```

### V3 Tests

```bash
# V3 tests should continue to pass
uv run pytest bassi/core_v3/tests/test_agent_session.py -v
```

### Manual Smoke Test

```bash
# V1 CLI should still work
bassi
> /help
> What is 2+2?
> /quit

# V3 Web UI should still work
bassi-web
# Open http://localhost:8766
# Send message "Hello"
# Verify response appears
```

---

## Migration Notes

### For Developers Adding New Tests

**OLD Pattern** (requires SDK):
```python
def test_something():
    agent = BassiAgent()
    # Test code that hits real API
```

**NEW Pattern** (uses mocks):
```python
def test_something(mock_client_factory, mock_agent_client):
    # Queue expected responses
    mock_agent_client.queue_response("Expected response")

    # Create agent with mock
    agent = BassiAgent(client_factory=mock_client_factory)

    # Test code that uses mock (no API calls)
    # ...

    # Verify mock interactions
    assert len(mock_agent_client.sent_prompts) == 1
```

---

### For Production Deployments

**No Changes Required**:
- Default factory still uses real Claude SDK
- No performance impact
- No behavior changes
- Factory parameter is optional

**New Capabilities**:
- ✅ Can inject custom client implementations
- ✅ Can test without SDK in CI
- ✅ Can mock agent for integration tests
- ✅ Can stub responses for development

---

## Code Quality Checks

After implementing, verify:

### 1. No Module-Level SDK Imports in V1

```bash
# Should return empty (V1 files)
rg "from claude_agent_sdk" bassi/agent.py
rg "import claude_agent_sdk" bassi/agent.py

# Should only find sdk_loader.py and agent_protocol.py
rg "from claude_agent_sdk" bassi/ --type py
```

### 2. Type Hints Use Protocol

```bash
# Should find AgentClient type, not ClaudeSDKClient
rg "ClaudeSDKClient" bassi/agent.py  # Should be empty
rg "AgentClient" bassi/agent.py      # Should find usages
```

### 3. All Tests Import MockAgentClient

```bash
# Should find imports in test files
rg "from tests.fixtures.mock_agent_client import MockAgentClient" tests/
```

### 4. Factory Pattern Used Consistently

```bash
# Should find _client_factory usage
rg "_client_factory" bassi/agent.py
rg "client_factory=" bassi/main.py
```

---

## Troubleshooting Guide

### Issue: "No module named 'claude_agent_sdk'"

**Cause**: Module-level import not removed

**Fix**: Check all imports in `bassi/agent.py` - should only import from `agent_protocol.py`

---

### Issue: Tests still require SDK

**Cause**: Tests not using mock fixtures

**Fix**: Ensure tests use `mock_client_factory` parameter:
```python
def test_something(mock_client_factory):
    agent = BassiAgent(client_factory=mock_client_factory)
```

---

### Issue: "TypeError: BassiAgent() got unexpected keyword argument 'client_factory'"

**Cause**: Changes to `__init__` not applied

**Fix**: Verify `bassi/agent.py` line ~220 has new parameter

---

### Issue: Mock responses not appearing

**Cause**: Forgot to queue responses

**Fix**: Always call `mock_agent_client.queue_response()` before chat:
```python
mock_agent_client.queue_response("Expected response")
async for chunk in agent.chat("Question"):
    # chunk will contain "Expected response"
```

---

## Performance Impact

**Expected**: Zero performance impact
- Factory call happens once per agent instance
- Same underlying SDK client created
- No additional allocations
- No runtime overhead

**Benchmarks** (optional):
```python
# Before (direct instantiation): ~1ms
# After (factory pattern): ~1ms
# Difference: negligible (< 0.1ms)
```

---

## Documentation Updates Required

After implementation, update:

1. **`docs/features_concepts/testing.md`** - Add section on mock usage
2. **`docs/design.md`** - Update architecture diagram to show factory pattern
3. **`README.md`** - Add note about testing without SDK
4. **`CLAUDE.md`** - Update testing instructions

---

## Summary

### Files Modified: 3
1. `bassi/agent.py` - Add dependency injection support
2. `tests/test_agent.py` - Add 5 new unit tests with mocks
3. `bassi/main.py` - Support factory parameter in entry point

### Files Verified: 2
4. `bassi/core_v3/web_server_v3.py` - Check factory usage
5. `bassi/core_v3/cli.py` - Check factory parameter

### New Capabilities
- ✅ V1 tests run without Claude SDK
- ✅ Mock agent behavior for unit tests
- ✅ Consistent DI pattern across V1 and V3
- ✅ CI can run all tests without API keys

### Backward Compatibility
- ✅ All existing code continues to work
- ✅ Default behavior unchanged
- ✅ Optional factory parameter
- ✅ Zero production impact

---

## Implementation Timeline

| Task | Estimated Time | Complexity |
|------|---------------|------------|
| Update `bassi/agent.py` | 30 minutes | Medium |
| Write 5 new tests in `test_agent.py` | 45 minutes | Medium |
| Update `bassi/main.py` | 15 minutes | Low |
| Verify V3 files | 10 minutes | Low |
| Run full test suite | 10 minutes | Low |
| **TOTAL** | **110 minutes** | **Medium** |

---

## Ready for Implementation ✅

This document contains all code needed to complete Phase 2.3.
Each change is isolated, testable, and reversible.
All patterns follow existing V3 implementation (proven working).
